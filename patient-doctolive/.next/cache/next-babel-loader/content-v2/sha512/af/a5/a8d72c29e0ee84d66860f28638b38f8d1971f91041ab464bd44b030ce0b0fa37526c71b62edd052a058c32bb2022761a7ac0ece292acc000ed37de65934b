{"ast":null,"code":"import { jsxDEV as _jsxDEV } from \"react/jsx-dev-runtime\";\nimport _classCallCheck from \"C:/app/doctolive_code/patient-doctolive/node_modules/next/node_modules/@babel/runtime/helpers/esm/classCallCheck\";\nimport _createClass from \"C:/app/doctolive_code/patient-doctolive/node_modules/next/node_modules/@babel/runtime/helpers/esm/createClass\";\nimport _assertThisInitialized from \"C:/app/doctolive_code/patient-doctolive/node_modules/next/node_modules/@babel/runtime/helpers/esm/assertThisInitialized\";\nimport _inherits from \"C:/app/doctolive_code/patient-doctolive/node_modules/next/node_modules/@babel/runtime/helpers/esm/inherits\";\nimport _possibleConstructorReturn from \"C:/app/doctolive_code/patient-doctolive/node_modules/next/node_modules/@babel/runtime/helpers/esm/possibleConstructorReturn\";\nimport _getPrototypeOf from \"C:/app/doctolive_code/patient-doctolive/node_modules/next/node_modules/@babel/runtime/helpers/esm/getPrototypeOf\";\nvar _jsxFileName = \"C:\\\\app\\\\doctolive_code\\\\patient-doctolive\\\\components\\\\Chat\\\\videoChat.jsx\";\n\nfunction _createSuper(Derived) { var hasNativeReflectConstruct = _isNativeReflectConstruct(); return function _createSuperInternal() { var Super = _getPrototypeOf(Derived), result; if (hasNativeReflectConstruct) { var NewTarget = _getPrototypeOf(this).constructor; result = Reflect.construct(Super, arguments, NewTarget); } else { result = Super.apply(this, arguments); } return _possibleConstructorReturn(this, result); }; }\n\nfunction _isNativeReflectConstruct() { if (typeof Reflect === \"undefined\" || !Reflect.construct) return false; if (Reflect.construct.sham) return false; if (typeof Proxy === \"function\") return true; try { Date.prototype.toString.call(Reflect.construct(Date, [], function () {})); return true; } catch (e) { return false; } }\n\nimport React, { Component } from 'react';\nimport Peer from 'simple-peer';\nimport autoBind from 'react-autobind'; // import Axios from 'axios'\n// import baseUrl from './../../config'\n\nimport { CircularProgress } from '@material-ui/core';\nimport { Button, Row, Col, Collapse, Alert } from 'react-bootstrap';\nimport { FaPhoneSlash, FaPhone, FaCheck } from 'react-icons/fa'; // import callerTone from './../../assets/media/callertone.mp3'\n// import LogoPng from './../../assets/img/pelia_logo.png'\n\nvar ElemenetsCall = /*#__PURE__*/function (_Component) {\n  _inherits(ElemenetsCall, _Component);\n\n  var _super = _createSuper(ElemenetsCall);\n\n  function ElemenetsCall(props) {\n    var _this;\n\n    _classCallCheck(this, ElemenetsCall);\n\n    _this = _super.call(this, props);\n    autoBind(_assertThisInitialized(_this));\n    _this.state = {\n      stream: null,\n      respondingProcess: true,\n      errorMedia: {\n        error: false\n      }\n    };\n    return _this;\n  }\n\n  _createClass(ElemenetsCall, [{\n    key: \"componentDidMount\",\n    value: function componentDidMount() {\n      var _this2 = this;\n\n      var constraints = {\n        video: {\n          facingMode: \"user\",\n          width: 640,\n          height: 480,\n          cursor: \"motion\"\n        },\n        audio: true\n      };\n      this.initiatorCallVideo(constraints).then(function (stream) {\n        window.streamReference = stream;\n\n        _this2.props.socket.emit('patient-ready', {\n          selectedUser: 'm' + _this2.props.medecin.id\n        }, function () {}); // let videoStream = new MediaStream(stream.getVideoTracks(), options);\n\n\n        try {\n          _this2.myVideo.srcObject = stream;\n        } catch (e) {\n          _this2.myVideo.src = URL.createObjectURL(stream);\n        }\n\n        _this2.myVideo.play(); // try {\n        //     this.callerTone.src = callerTone\n        // } catch (e) {\n        //     this.callerTone.srcObject =  URL.createObjectURL(callerTone) \n        // }\n        // this.callerTone.play();\n\n\n        _this2.setState({\n          stream: stream,\n          respondingProcess: false\n        });\n      })[\"catch\"](function (err) {\n        _this2.cameraAuthDenied();\n\n        console.log(\"Unable to fetsh stream \".concat(err));\n      });\n      this.setupSocket();\n    }\n  }, {\n    key: \"componentWillUnmount\",\n    value: function componentWillUnmount() {\n      this.props.socket.removeAllListeners('patient-signal-call');\n      this.props.socket.removeAllListeners('patient-call');\n      this.props.socket.removeAllListeners('reject-call-patient');\n\n      if (this.state.peer) {\n        this.state.peer.destroy();\n      }\n    }\n  }, {\n    key: \"setupSocket\",\n    value: function setupSocket() {\n      var _this3 = this;\n\n      var socket = this.props.socket;\n      socket.on('patient-call', function (response) {});\n      socket.on('reject-call-patient', function (response) {\n        _this3.stopStream();\n\n        _this3.setState({\n          respondingProcess: false,\n          passingCall: false,\n          responding: false\n        });\n\n        _this3.props.setonCalling(false);\n      });\n      socket.on('patient-signal-call', function (_ref) {\n        var data = _ref.data;\n\n        _this3.setState({\n          responding: true\n        });\n\n        _this3.state.peer.signal(data);\n      });\n    }\n  }, {\n    key: \"cameraAuthDenied\",\n    value: function cameraAuthDenied(reason) {\n      this.setState({\n        errorMedia: {\n          error: true,\n          reason: reason\n        }\n      });\n    }\n  }, {\n    key: \"initiatorCallVideo\",\n    value: function initiatorCallVideo(constraints) {\n      return new Promise(function (resolve, reject) {\n        navigator.mediaDevices.getUserMedia(constraints).then(function (stream) {\n          resolve(stream);\n        })[\"catch\"](function (err) {\n          reject(err);\n        });\n      });\n    }\n  }, {\n    key: \"stopStream\",\n    value: function stopStream() {\n      if (this.callerTone !== null) {\n        this.callerTone.muted = true;\n        this.callerTone = null;\n      }\n\n      if (!window.streamReference) return;\n      window.streamReference.getAudioTracks().forEach(function (track) {\n        track.stop();\n      });\n      window.streamReference.getVideoTracks().forEach(function (track) {\n        track.stop();\n      });\n      window.streamReference = null;\n    }\n  }, {\n    key: \"confirmCall\",\n    value: function confirmCall() {\n      var _this4 = this;\n\n      var peer = new Peer({\n        initiator: true,\n        stream: this.state.stream,\n        config: {\n          iceServers: [{\n            urls: \"stun:pelia.ma:3478\"\n          }, {\n            urls: \"turn:pelia.ma:3478\",\n            username: \"peliaturn\",\n            credential: \"ejfLUNE6C=fM&4P!\"\n          }]\n        },\n        trickle: false\n      });\n      peer.on('signal', function (data) {\n        _this4.props.socket.emit('confirm-call', {\n          selectedUser: 'm' + _this4.props.medecin.id,\n          data: data\n        }, function () {});\n      });\n      peer.on('stream', function (stream) {\n        _this4.callerTone.pause();\n\n        try {\n          _this4.userVideo.srcObject = stream;\n        } catch (e) {\n          _this4.userVideo.src = URL.createObjectURL(stream);\n        }\n\n        _this4.userVideo.play();\n\n        _this4.setState({\n          passingCall: true,\n          respondingProcess: false,\n          timeAppel: Date.now()\n        });\n      });\n      peer.on('close', function () {\n        _this4.stopStream();\n\n        _this4.setState({\n          respondingProcess: false,\n          passingCall: false,\n          responding: false\n        }); // this.props.setonCalling(false)\n\n\n        if (_this4.state.peer) {\n          _this4.state.peer.destroy();\n        }\n      });\n      peer.on('error', function (err) {\n        console.log(\"vous avez perdue la connextion avec votre patient \".concat(err));\n      });\n      this.setState({\n        respondingProcess: true,\n        peer: peer\n      });\n    }\n  }, {\n    key: \"rejectCall\",\n    value: function rejectCall() {\n      this.stopStream();\n      this.setState({\n        respondingProcess: false,\n        passingCall: false,\n        responding: false\n      });\n      this.props.socket.emit('patient-reject-call', {\n        selectedUser: 'm' + this.props.medecin.id\n      });\n      this.props.setonCalling(false);\n    }\n  }, {\n    key: \"render\",\n    value: function render() {\n      var _this5 = this;\n\n      var _this$state = this.state,\n          responding = _this$state.responding,\n          passingCall = _this$state.passingCall,\n          respondingProcess = _this$state.respondingProcess;\n      return /*#__PURE__*/_jsxDEV(\"div\", {\n        className: \"video patient\",\n        children: [/*#__PURE__*/_jsxDEV(\"audio\", {\n          ref: function ref(_ref2) {\n            return _this5.callerTone = _ref2;\n          },\n          playsInline: true,\n          loop: true\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 182,\n          columnNumber: 17\n        }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n          className: responding ? \"repondre video-container\" : \"video-container\",\n          children: [/*#__PURE__*/_jsxDEV(\"video\", {\n            id: \"peerVid\",\n            ref: function ref(_ref3) {\n              _this5.userVideo = _ref3;\n            },\n            playsInline: true,\n            autoPlay: true\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 184,\n            columnNumber: 21\n          }, this), /*#__PURE__*/_jsxDEV(Row, {\n            className: \"justify-content-center m-0\",\n            children: /*#__PURE__*/_jsxDEV(\"video\", {\n              id: \"myVid\",\n              muted: true,\n              ref: function ref(_ref4) {\n                _this5.myVideo = _ref4;\n              },\n              playsInline: true,\n              autoPlay: true\n            }, void 0, false, {\n              fileName: _jsxFileName,\n              lineNumber: 186,\n              columnNumber: 21\n            }, this)\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 185,\n            columnNumber: 17\n          }, this), /*#__PURE__*/_jsxDEV(Row, {\n            className: !passingCall ? \"responding process m-0\" : \"responding m-0\",\n            children: /*#__PURE__*/_jsxDEV(Col, {\n              className: \"p-0\",\n              children: [/*#__PURE__*/_jsxDEV(\"div\", {\n                className: \"layer\"\n              }, void 0, false, {\n                fileName: _jsxFileName,\n                lineNumber: 191,\n                columnNumber: 21\n              }, this), /*#__PURE__*/_jsxDEV(Row, {\n                className: \"mt-5\",\n                children: /*#__PURE__*/_jsxDEV(Collapse, {\n                  \"in\": this.state.errorMedia.error,\n                  children: /*#__PURE__*/_jsxDEV(\"div\", {\n                    id: \"example-collapse-text\",\n                    style: {\n                      zIndex: 999\n                    },\n                    children: /*#__PURE__*/_jsxDEV(Alert, {\n                      variant: \"danger\",\n                      children: \"Vous ne autoris\\xE9 pas l'acc\\xE9s au camera pour le site ocp.pelia.ma. Changer vos param\\xE9tre pour pouvoir communiquer avec votre m\\xE9decin\"\n                    }, void 0, false, {\n                      fileName: _jsxFileName,\n                      lineNumber: 196,\n                      columnNumber: 37\n                    }, this)\n                  }, void 0, false, {\n                    fileName: _jsxFileName,\n                    lineNumber: 195,\n                    columnNumber: 33\n                  }, this)\n                }, void 0, false, {\n                  fileName: _jsxFileName,\n                  lineNumber: 194,\n                  columnNumber: 29\n                }, this)\n              }, void 0, false, {\n                fileName: _jsxFileName,\n                lineNumber: 193,\n                columnNumber: 25\n              }, this), !passingCall && /*#__PURE__*/_jsxDEV(Row, {\n                className: \"text-center d-flex justify-content-around w-100 p-4 ml-1 mt-5\",\n                children: /*#__PURE__*/_jsxDEV(\"p\", {\n                  className: \"text-center caller \",\n                  style: {\n                    maxHeight: \"20%\"\n                  },\n                  children: \" Un appel entrant de la part de votre m\\xE9decin\"\n                }, void 0, false, {\n                  fileName: _jsxFileName,\n                  lineNumber: 205,\n                  columnNumber: 37\n                }, this)\n              }, void 0, false, {\n                fileName: _jsxFileName,\n                lineNumber: 204,\n                columnNumber: 33\n              }, this), /*#__PURE__*/_jsxDEV(Row, {\n                className: \"end-call\",\n                children: [/*#__PURE__*/_jsxDEV(ButtonProcess, {\n                  className: \"action\",\n                  onClick: this.rejectCall,\n                  type: \"button\",\n                  variant: \"danger\",\n                  sending: respondingProcess,\n                  IconSuccess: FaCheck,\n                  Icon: /*#__PURE__*/_jsxDEV(FaPhoneSlash, {\n                    size: \"1.5rem\"\n                  }, void 0, false, {\n                    fileName: _jsxFileName,\n                    lineNumber: 216,\n                    columnNumber: 43\n                  }, this)\n                }, void 0, false, {\n                  fileName: _jsxFileName,\n                  lineNumber: 209,\n                  columnNumber: 29\n                }, this), !passingCall && /*#__PURE__*/_jsxDEV(ButtonProcess, {\n                  className: \"action\",\n                  onClick: this.confirmCall,\n                  type: \"button\",\n                  variant: \"success\",\n                  sending: respondingProcess,\n                  IconSuccess: FaCheck,\n                  Icon: /*#__PURE__*/_jsxDEV(FaPhone, {\n                    size: \"1.5rem\"\n                  }, void 0, false, {\n                    fileName: _jsxFileName,\n                    lineNumber: 227,\n                    columnNumber: 43\n                  }, this)\n                }, void 0, false, {\n                  fileName: _jsxFileName,\n                  lineNumber: 220,\n                  columnNumber: 33\n                }, this)]\n              }, void 0, true, {\n                fileName: _jsxFileName,\n                lineNumber: 208,\n                columnNumber: 25\n              }, this)]\n            }, void 0, true, {\n              fileName: _jsxFileName,\n              lineNumber: 190,\n              columnNumber: 21\n            }, this)\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 189,\n            columnNumber: 17\n          }, this)]\n        }, void 0, true, {\n          fileName: _jsxFileName,\n          lineNumber: 183,\n          columnNumber: 17\n        }, this)]\n      }, void 0, true, {\n        fileName: _jsxFileName,\n        lineNumber: 181,\n        columnNumber: 13\n      }, this);\n    }\n  }]);\n\n  return ElemenetsCall;\n}(Component);\n\nexport { ElemenetsCall as default };\n\nfunction ButtonProcess(props) {\n  return /*#__PURE__*/_jsxDEV(\"div\", {\n    style: {\n      display: \"flex\",\n      justifyContent: \"center\",\n      position: 'relative'\n    },\n    children: [/*#__PURE__*/_jsxDEV(Button, {\n      onClick: props.onClick,\n      className: props.className,\n      type: props.type,\n      variant: props.variant,\n      disabled: props.sending,\n      children: props.Icon\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 248,\n      columnNumber: 9\n    }, this), props.sending && /*#__PURE__*/_jsxDEV(CircularProgress, {\n      size: 24,\n      style: {\n        color: \"#8dc63f\",\n        position: 'absolute',\n        top: '50%',\n        left: '50%',\n        marginTop: -12,\n        marginLeft: -12\n      }\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 257,\n      columnNumber: 27\n    }, this)]\n  }, void 0, true, {\n    fileName: _jsxFileName,\n    lineNumber: 243,\n    columnNumber: 7\n  }, this);\n}\n\n_c = ButtonProcess;\n\nvar _c;\n\n$RefreshReg$(_c, \"ButtonProcess\");","map":{"version":3,"sources":["C:/app/doctolive_code/patient-doctolive/components/Chat/videoChat.jsx"],"names":["React","Component","Peer","autoBind","CircularProgress","Button","Row","Col","Collapse","Alert","FaPhoneSlash","FaPhone","FaCheck","ElemenetsCall","props","state","stream","respondingProcess","errorMedia","error","constraints","video","facingMode","width","height","cursor","audio","initiatorCallVideo","then","window","streamReference","socket","emit","selectedUser","medecin","id","myVideo","srcObject","e","src","URL","createObjectURL","play","setState","err","cameraAuthDenied","console","log","setupSocket","removeAllListeners","peer","destroy","on","response","stopStream","passingCall","responding","setonCalling","data","signal","reason","Promise","resolve","reject","navigator","mediaDevices","getUserMedia","callerTone","muted","getAudioTracks","forEach","track","stop","getVideoTracks","initiator","config","iceServers","urls","username","credential","trickle","pause","userVideo","timeAppel","Date","now","ref","zIndex","maxHeight","rejectCall","confirmCall","ButtonProcess","display","justifyContent","position","onClick","className","type","variant","sending","Icon","color","top","left","marginTop","marginLeft"],"mappings":"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","sourcesContent":["\r\n\r\nimport React, { Component } from 'react';\r\nimport Peer from 'simple-peer';\r\nimport autoBind from 'react-autobind';\r\n// import Axios from 'axios'\r\n\r\n// import baseUrl from './../../config'\r\n\r\nimport {CircularProgress} from '@material-ui/core';\r\nimport { Button, Row, Col, Collapse, Alert} from 'react-bootstrap'\r\nimport {FaPhoneSlash, FaPhone, FaCheck} from 'react-icons/fa'\r\n// import callerTone from './../../assets/media/callertone.mp3'\r\n\r\n// import LogoPng from './../../assets/img/pelia_logo.png'\r\n\r\n\r\nexport default class ElemenetsCall extends Component {\r\n    constructor(props) {\r\n        super(props);\r\n        autoBind(this);\r\n        this.state = {\r\n            stream: null,\r\n            respondingProcess:true,\r\n            errorMedia:{error:false}\r\n        };\r\n    }\r\n    componentDidMount() {\r\n        const constraints={\r\n            video: {\r\n                facingMode: \"user\", \r\n                width: 640, \r\n                height: 480, \r\n                cursor:\"motion\"\r\n            }, \r\n            audio:true\r\n         }\r\n\r\n        this.initiatorCallVideo(constraints)\r\n        .then((stream) => {\r\n            window.streamReference = stream;           \r\n            this.props.socket.emit('patient-ready', {selectedUser: 'm' + this.props.medecin.id}, () => { } )\r\n            // let videoStream = new MediaStream(stream.getVideoTracks(), options);\r\n            try {\r\n                this.myVideo.srcObject = stream;\r\n            } catch (e) {\r\n                this.myVideo.src = URL.createObjectURL(stream)\r\n            }\r\n            this.myVideo.play();\r\n            // try {\r\n            //     this.callerTone.src = callerTone\r\n            // } catch (e) {\r\n            //     this.callerTone.srcObject =  URL.createObjectURL(callerTone) \r\n            // }\r\n            // this.callerTone.play();\r\n            this.setState({ stream : stream, respondingProcess: false})\r\n        })\r\n        .catch((err)=> {\r\n            this.cameraAuthDenied()\r\n            console.log(`Unable to fetsh stream ${err}`)\r\n        })\r\n        this.setupSocket()\r\n    }\r\n    componentWillUnmount(){\r\n        this.props.socket.removeAllListeners('patient-signal-call')\r\n        this.props.socket.removeAllListeners('patient-call')\r\n        this.props.socket.removeAllListeners('reject-call-patient')\r\n\r\n        if(this.state.peer){\r\n            this.state.peer.destroy();\r\n        }\r\n    }\r\n    setupSocket(){\r\n        let socket = this.props.socket;\r\n        socket.on('patient-call', (response) => {\r\n   \r\n        })\r\n        socket.on('reject-call-patient', (response) => {\r\n            this.stopStream();\r\n            this.setState({ respondingProcess:false, passingCall: false,responding:false});\r\n            this.props.setonCalling(false)\r\n        })\r\n        socket.on('patient-signal-call', ({data}) => {\r\n            this.setState({responding: true})\r\n            this.state.peer.signal(data);\r\n        })\r\n    }\r\n\r\n    cameraAuthDenied(reason){\r\n        this.setState({errorMedia: {error: true, reason}})\r\n    }\r\n    \r\n     initiatorCallVideo(constraints){\r\n      \r\n        return new Promise((resolve, reject) => {\r\n            navigator.mediaDevices.getUserMedia(constraints)\r\n            .then((stream) => {\r\n                resolve(stream)\r\n            })\r\n            .catch(err => {\r\n                reject(err)\r\n            })\r\n        });\r\n    }\r\n    \r\n    stopStream() {\r\n        if(this.callerTone !== null){\r\n            this.callerTone.muted = true;\r\n            this.callerTone= null;\r\n        }\r\n        if (!window.streamReference) return;\r\n        window.streamReference.getAudioTracks().forEach( (track) => {\r\n            track.stop();\r\n        });\r\n        window.streamReference.getVideoTracks().forEach( (track) => {\r\n            track.stop();\r\n        });\r\n        window.streamReference = null;\r\n    }\r\n\r\n\r\n    confirmCall(){\r\n    const peer = new Peer({\r\n        initiator:true,\r\n        stream: this.state.stream,\r\n        config: { iceServers: \r\n            [\r\n                {\r\n                    urls: \"stun:pelia.ma:3478\",\r\n                },\r\n                {\r\n                    urls: \"turn:pelia.ma:3478\",\r\n                    username: \"peliaturn\",\r\n                    credential: \"ejfLUNE6C=fM&4P!\"\r\n                }\r\n            ]\r\n        },\r\n        trickle: false\r\n    });\r\n    peer.on('signal', (data) => {\r\n        this.props.socket.emit('confirm-call', {selectedUser: 'm' + this.props.medecin.id, data }, () => { })\r\n    })\r\n\r\n    peer.on('stream', (stream) => {\r\n        this.callerTone.pause();\r\n        try {\r\n            this.userVideo.srcObject = stream;\r\n        } catch (e) {\r\n            this.userVideo.src = URL.createObjectURL(stream)\r\n        }\r\n        this.userVideo.play();\r\n        this.setState({passingCall: true, respondingProcess:false, timeAppel: Date.now() })\r\n    })\r\n    peer.on('close', () =>{\r\n        this.stopStream();\r\n        this.setState({ respondingProcess:false, passingCall: false,responding:false });\r\n        // this.props.setonCalling(false)\r\n        if(this.state.peer){\r\n            this.state.peer.destroy()\r\n        }\r\n    });\r\n\r\n    peer.on('error', (err) => {\r\n        console.log( `vous avez perdue la connextion avec votre patient ${err}`)\r\n    });\r\n    this.setState({ respondingProcess: true, peer});\r\n    \r\n    }\r\n\r\n    rejectCall(){\r\n\r\n            this.stopStream();\r\n            this.setState({ respondingProcess:false, passingCall: false, responding:false});\r\n            this.props.socket.emit('patient-reject-call', {selectedUser: 'm' + this.props.medecin.id})\r\n            this.props.setonCalling(false)\r\n    }\r\n      \r\n    render() {\r\n        let {responding, passingCall, respondingProcess } = this.state;\r\n        return (\r\n            <div className=\"video patient\">\r\n                <audio ref={ref => this.callerTone = ref} playsInline loop />\r\n                <div className={responding ? \"repondre video-container\" : \"video-container\"}>\r\n                    <video id=\"peerVid\" ref={(ref) => {this.userVideo = ref;}} playsInline autoPlay />\r\n                <Row className=\"justify-content-center m-0\">\r\n                    <video id=\"myVid\" muted={true} ref={(ref) => {this.myVideo = ref;}} playsInline autoPlay />\r\n                </Row>    \r\n\r\n                <Row className={!passingCall ? \"responding process m-0\": \"responding m-0\"}>   \r\n                    <Col className=\"p-0\">\r\n                    <div className=\"layer\"></div>\r\n                        \r\n                        <Row className=\"mt-5\">\r\n                            <Collapse in={this.state.errorMedia.error}>\r\n                                <div id=\"example-collapse-text\" style={{zIndex:999}}>\r\n                                    <Alert  variant=\"danger\">\r\n                                        Vous ne autorisé pas l'accés au camera pour le site ocp.pelia.ma. Changer vos paramétre pour pouvoir communiquer avec votre médecin\r\n                                    </Alert>\r\n                                </div>\r\n                            </Collapse>\r\n                        </Row>\r\n                        \r\n                            { !passingCall &&                      \r\n                                <Row className=\"text-center d-flex justify-content-around w-100 p-4 ml-1 mt-5\">   \r\n                                    <p className=\"text-center caller \" style={{maxHeight: \"20%\"}}> Un appel entrant de la part de votre médecin</p>\r\n                                </Row>    \r\n                            }\r\n                        <Row className=\"end-call\">\r\n                            <ButtonProcess \r\n                                    className=\"action\" \r\n                                    onClick={this.rejectCall} \r\n                                    type=\"button\"   \r\n                                    variant=\"danger\" \r\n                                    sending={respondingProcess} \r\n                                    IconSuccess={FaCheck} \r\n                                    Icon={<FaPhoneSlash size=\"1.5rem\" />}\r\n                                />\r\n                                    \r\n                            { !passingCall &&\r\n                                <ButtonProcess \r\n                                    className=\"action\" \r\n                                    onClick={this.confirmCall} \r\n                                    type=\"button\" \r\n                                    variant=\"success\" \r\n                                    sending={respondingProcess} \r\n                                    IconSuccess={FaCheck} \r\n                                    Icon={<FaPhone size=\"1.5rem\" />}\r\n                                />\r\n                            }\r\n                        </Row>\r\n                    </Col>\r\n                </Row>\r\n                \r\n               \r\n                </div>\r\n            </div>\r\n        );\r\n    }\r\n}\r\n\r\nfunction ButtonProcess(props) {\r\n  return (\r\n      <div style={{\r\n        display:\"flex\",\r\n        justifyContent:\"center\",\r\n        position: 'relative',\r\n      }}>\r\n        <Button\r\n        onClick={props.onClick }\r\n        className={props.className}\r\n          type={props.type}\r\n          variant= {props.variant}\r\n          disabled={props.sending}\r\n        >\r\n           {props.Icon}\r\n        </Button>\r\n        {props.sending && <CircularProgress size={24} style={ {color: \"#8dc63f\", position: 'absolute',top: '50%', left: '50%',marginTop: -12,marginLeft: -12}}  /> }\r\n      </div>\r\n  );\r\n}\r\n\r\n\r\n"]},"metadata":{},"sourceType":"module"}