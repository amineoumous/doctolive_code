{"ast":null,"code":"import { jsxs as _jsxs } from \"react/jsx-runtime\";\nimport { jsx as _jsx } from \"react/jsx-runtime\";\nimport _classCallCheck from \"C:/app/doctolive_code/patient-doctolive/node_modules/next/node_modules/@babel/runtime/helpers/esm/classCallCheck\";\nimport _createClass from \"C:/app/doctolive_code/patient-doctolive/node_modules/next/node_modules/@babel/runtime/helpers/esm/createClass\";\nimport _assertThisInitialized from \"C:/app/doctolive_code/patient-doctolive/node_modules/next/node_modules/@babel/runtime/helpers/esm/assertThisInitialized\";\nimport _inherits from \"C:/app/doctolive_code/patient-doctolive/node_modules/next/node_modules/@babel/runtime/helpers/esm/inherits\";\nimport _possibleConstructorReturn from \"C:/app/doctolive_code/patient-doctolive/node_modules/next/node_modules/@babel/runtime/helpers/esm/possibleConstructorReturn\";\nimport _getPrototypeOf from \"C:/app/doctolive_code/patient-doctolive/node_modules/next/node_modules/@babel/runtime/helpers/esm/getPrototypeOf\";\n\nfunction _createSuper(Derived) { var hasNativeReflectConstruct = _isNativeReflectConstruct(); return function _createSuperInternal() { var Super = _getPrototypeOf(Derived), result; if (hasNativeReflectConstruct) { var NewTarget = _getPrototypeOf(this).constructor; result = Reflect.construct(Super, arguments, NewTarget); } else { result = Super.apply(this, arguments); } return _possibleConstructorReturn(this, result); }; }\n\nfunction _isNativeReflectConstruct() { if (typeof Reflect === \"undefined\" || !Reflect.construct) return false; if (Reflect.construct.sham) return false; if (typeof Proxy === \"function\") return true; try { Date.prototype.toString.call(Reflect.construct(Date, [], function () {})); return true; } catch (e) { return false; } }\n\nimport React, { Component } from 'react';\nimport Peer from 'simple-peer';\nimport autoBind from 'react-autobind'; // import Axios from 'axios'\n// import baseUrl from './../../config'\n\nimport { CircularProgress } from '@material-ui/core';\nimport { Button, Row, Col, Collapse, Alert } from 'react-bootstrap';\nimport { FaPhoneSlash, FaPhone, FaCheck } from 'react-icons/fa'; // import callerTone from './../../assets/media/callertone.mp3'\n// import LogoPng from './../../assets/img/pelia_logo.png'\n\nvar ElemenetsCall = /*#__PURE__*/function (_Component) {\n  _inherits(ElemenetsCall, _Component);\n\n  var _super = _createSuper(ElemenetsCall);\n\n  function ElemenetsCall(props) {\n    var _this;\n\n    _classCallCheck(this, ElemenetsCall);\n\n    _this = _super.call(this, props);\n    autoBind(_assertThisInitialized(_this));\n    _this.state = {\n      stream: null,\n      respondingProcess: true,\n      errorMedia: {\n        error: false\n      }\n    };\n    return _this;\n  }\n\n  _createClass(ElemenetsCall, [{\n    key: \"componentDidMount\",\n    value: function componentDidMount() {\n      var _this2 = this;\n\n      var constraints = {\n        video: {\n          facingMode: \"user\",\n          width: 640,\n          height: 480,\n          cursor: \"motion\"\n        },\n        audio: true\n      };\n      this.initiatorCallVideo(constraints).then(function (stream) {\n        window.streamReference = stream;\n\n        _this2.props.socket.emit('patient-ready', {\n          selectedUser: 'm' + _this2.props.medecin.id\n        }, function () {}); // let videoStream = new MediaStream(stream.getVideoTracks(), options);\n\n\n        try {\n          _this2.myVideo.srcObject = stream;\n        } catch (e) {\n          _this2.myVideo.src = URL.createObjectURL(stream);\n        }\n\n        _this2.myVideo.play(); // try {\n        //     this.callerTone.src = callerTone\n        // } catch (e) {\n        //     this.callerTone.srcObject =  URL.createObjectURL(callerTone) \n        // }\n        // this.callerTone.play();\n\n\n        _this2.setState({\n          stream: stream,\n          respondingProcess: false\n        });\n      })[\"catch\"](function (err) {\n        _this2.cameraAuthDenied();\n\n        console.log(\"Unable to fetsh stream \".concat(err));\n      });\n      this.setupSocket();\n    }\n  }, {\n    key: \"componentWillUnmount\",\n    value: function componentWillUnmount() {\n      this.props.socket.removeAllListeners('patient-signal-call');\n      this.props.socket.removeAllListeners('patient-call');\n      this.props.socket.removeAllListeners('reject-call-patient');\n\n      if (this.state.peer) {\n        this.state.peer.destroy();\n      }\n    }\n  }, {\n    key: \"setupSocket\",\n    value: function setupSocket() {\n      var _this3 = this;\n\n      var socket = this.props.socket;\n      socket.on('patient-call', function (response) {});\n      socket.on('reject-call-patient', function (response) {\n        _this3.stopStream();\n\n        _this3.setState({\n          respondingProcess: false,\n          passingCall: false,\n          responding: false\n        });\n\n        _this3.props.setonCalling(false);\n      });\n      socket.on('patient-signal-call', function (_ref) {\n        var data = _ref.data;\n\n        _this3.setState({\n          responding: true\n        });\n\n        _this3.state.peer.signal(data);\n      });\n    }\n  }, {\n    key: \"cameraAuthDenied\",\n    value: function cameraAuthDenied(reason) {\n      this.setState({\n        errorMedia: {\n          error: true,\n          reason: reason\n        }\n      });\n    }\n  }, {\n    key: \"initiatorCallVideo\",\n    value: function initiatorCallVideo(constraints) {\n      return new Promise(function (resolve, reject) {\n        navigator.mediaDevices.getUserMedia(constraints).then(function (stream) {\n          resolve(stream);\n        })[\"catch\"](function (err) {\n          reject(err);\n        });\n      });\n    }\n  }, {\n    key: \"stopStream\",\n    value: function stopStream() {\n      if (this.callerTone !== null) {\n        this.callerTone.muted = true;\n        this.callerTone = null;\n      }\n\n      if (!window.streamReference) return;\n      window.streamReference.getAudioTracks().forEach(function (track) {\n        track.stop();\n      });\n      window.streamReference.getVideoTracks().forEach(function (track) {\n        track.stop();\n      });\n      window.streamReference = null;\n    }\n  }, {\n    key: \"confirmCall\",\n    value: function confirmCall() {\n      var _this4 = this;\n\n      var peer = new Peer({\n        initiator: true,\n        stream: this.state.stream,\n        config: {\n          iceServers: [{\n            urls: \"stun:pelia.ma:3478\"\n          }, {\n            urls: \"turn:pelia.ma:3478\",\n            username: \"peliaturn\",\n            credential: \"ejfLUNE6C=fM&4P!\"\n          }]\n        },\n        trickle: false\n      });\n      peer.on('signal', function (data) {\n        _this4.props.socket.emit('confirm-call', {\n          selectedUser: 'm' + _this4.props.medecin.id,\n          data: data\n        }, function () {});\n      });\n      peer.on('stream', function (stream) {\n        _this4.callerTone.pause();\n\n        try {\n          _this4.userVideo.srcObject = stream;\n        } catch (e) {\n          _this4.userVideo.src = URL.createObjectURL(stream);\n        }\n\n        _this4.userVideo.play();\n\n        _this4.setState({\n          passingCall: true,\n          respondingProcess: false,\n          timeAppel: Date.now()\n        });\n      });\n      peer.on('close', function () {\n        _this4.stopStream();\n\n        _this4.setState({\n          respondingProcess: false,\n          passingCall: false,\n          responding: false\n        }); // this.props.setonCalling(false)\n\n\n        if (_this4.state.peer) {\n          _this4.state.peer.destroy();\n        }\n      });\n      peer.on('error', function (err) {\n        console.log(\"vous avez perdue la connextion avec votre patient \".concat(err));\n      });\n      this.setState({\n        respondingProcess: true,\n        peer: peer\n      });\n    }\n  }, {\n    key: \"rejectCall\",\n    value: function rejectCall() {\n      this.stopStream();\n      this.setState({\n        respondingProcess: false,\n        passingCall: false,\n        responding: false\n      });\n      this.props.socket.emit('patient-reject-call', {\n        selectedUser: 'm' + this.props.medecin.id\n      });\n      this.props.setonCalling(false);\n    }\n  }, {\n    key: \"render\",\n    value: function render() {\n      var _this5 = this;\n\n      var _this$state = this.state,\n          responding = _this$state.responding,\n          passingCall = _this$state.passingCall,\n          respondingProcess = _this$state.respondingProcess;\n      return /*#__PURE__*/_jsxs(\"div\", {\n        className: \"video patient\",\n        children: [/*#__PURE__*/_jsx(\"audio\", {\n          ref: function ref(_ref2) {\n            return _this5.callerTone = _ref2;\n          },\n          playsInline: true,\n          loop: true\n        }), /*#__PURE__*/_jsxs(\"div\", {\n          className: responding ? \"repondre video-container\" : \"video-container\",\n          children: [/*#__PURE__*/_jsx(\"video\", {\n            id: \"peerVid\",\n            ref: function ref(_ref3) {\n              _this5.userVideo = _ref3;\n            },\n            playsInline: true,\n            autoPlay: true\n          }), /*#__PURE__*/_jsx(Row, {\n            className: \"justify-content-center m-0\",\n            children: /*#__PURE__*/_jsx(\"video\", {\n              id: \"myVid\",\n              muted: true,\n              ref: function ref(_ref4) {\n                _this5.myVideo = _ref4;\n              },\n              playsInline: true,\n              autoPlay: true\n            })\n          }), /*#__PURE__*/_jsx(Row, {\n            className: !passingCall ? \"responding process m-0\" : \"responding m-0\",\n            children: /*#__PURE__*/_jsxs(Col, {\n              className: \"p-0\",\n              children: [/*#__PURE__*/_jsx(\"div\", {\n                className: \"layer\"\n              }), /*#__PURE__*/_jsx(Row, {\n                className: \"mt-5\",\n                children: /*#__PURE__*/_jsx(Collapse, {\n                  \"in\": this.state.errorMedia.error,\n                  children: /*#__PURE__*/_jsx(\"div\", {\n                    id: \"example-collapse-text\",\n                    style: {\n                      zIndex: 999\n                    },\n                    children: /*#__PURE__*/_jsx(Alert, {\n                      variant: \"danger\",\n                      children: \"Vous ne autoris\\xE9 pas l'acc\\xE9s au camera pour le site ocp.pelia.ma. Changer vos param\\xE9tre pour pouvoir communiquer avec votre m\\xE9decin\"\n                    })\n                  })\n                })\n              }), !passingCall && /*#__PURE__*/_jsx(Row, {\n                className: \"text-center d-flex justify-content-around w-100 p-4 ml-1 mt-5\",\n                children: /*#__PURE__*/_jsx(\"p\", {\n                  className: \"text-center caller \",\n                  style: {\n                    maxHeight: \"20%\"\n                  },\n                  children: \" Un appel entrant de la part de votre m\\xE9decin\"\n                })\n              }), /*#__PURE__*/_jsxs(Row, {\n                className: \"end-call\",\n                children: [/*#__PURE__*/_jsx(ButtonProcess, {\n                  className: \"action\",\n                  onClick: this.rejectCall,\n                  type: \"button\",\n                  variant: \"danger\",\n                  sending: respondingProcess,\n                  IconSuccess: FaCheck,\n                  Icon: /*#__PURE__*/_jsx(FaPhoneSlash, {\n                    size: \"1.5rem\"\n                  })\n                }), !passingCall && /*#__PURE__*/_jsx(ButtonProcess, {\n                  className: \"action\",\n                  onClick: this.confirmCall,\n                  type: \"button\",\n                  variant: \"success\",\n                  sending: respondingProcess,\n                  IconSuccess: FaCheck,\n                  Icon: /*#__PURE__*/_jsx(FaPhone, {\n                    size: \"1.5rem\"\n                  })\n                })]\n              })]\n            })\n          })]\n        })]\n      });\n    }\n  }]);\n\n  return ElemenetsCall;\n}(Component);\n\nexport { ElemenetsCall as default };\n\nfunction ButtonProcess(props) {\n  return /*#__PURE__*/_jsxs(\"div\", {\n    style: {\n      display: \"flex\",\n      justifyContent: \"center\",\n      position: 'relative'\n    },\n    children: [/*#__PURE__*/_jsx(Button, {\n      onClick: props.onClick,\n      className: props.className,\n      type: props.type,\n      variant: props.variant,\n      disabled: props.sending,\n      children: props.Icon\n    }), props.sending && /*#__PURE__*/_jsx(CircularProgress, {\n      size: 24,\n      style: {\n        color: \"#8dc63f\",\n        position: 'absolute',\n        top: '50%',\n        left: '50%',\n        marginTop: -12,\n        marginLeft: -12\n      }\n    })]\n  });\n}","map":null,"metadata":{},"sourceType":"module"}