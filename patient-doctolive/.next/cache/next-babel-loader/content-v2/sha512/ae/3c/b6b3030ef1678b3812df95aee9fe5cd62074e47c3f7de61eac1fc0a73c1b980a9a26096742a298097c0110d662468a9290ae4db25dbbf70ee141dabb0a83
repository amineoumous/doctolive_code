{"ast":null,"code":"import { jsxDEV as _jsxDEV } from \"react/jsx-dev-runtime\";\nvar _jsxFileName = \"C:\\\\app\\\\doctolive_code\\\\patient-doctolive\\\\components\\\\Chat\\\\videoChat.jsx\";\nimport React, { Component } from 'react';\nimport Peer from 'simple-peer';\nimport autoBind from 'react-autobind'; // import Axios from 'axios'\n// import baseUrl from './../../config'\n\nimport { CircularProgress } from '@material-ui/core';\nimport { Button, Row, Col, Collapse, Alert } from 'react-bootstrap';\nimport { FaPhoneSlash, FaPhone, FaCheck } from 'react-icons/fa'; // import callerTone from './../../assets/media/callertone.mp3'\n// import LogoPng from './../../assets/img/pelia_logo.png'\n\nexport default class ElemenetsCall extends Component {\n  constructor(props) {\n    super(props);\n    autoBind(this);\n    this.state = {\n      stream: null,\n      respondingProcess: true,\n      errorMedia: {\n        error: false\n      }\n    };\n  }\n\n  componentDidMount() {\n    const constraints = {\n      video: {\n        facingMode: \"user\",\n        width: 640,\n        height: 480,\n        cursor: \"motion\"\n      },\n      audio: true\n    };\n    this.initiatorCallVideo(constraints).then(stream => {\n      window.streamReference = stream;\n      this.props.socket.emit('patient-ready', {\n        selectedUser: 'm' + this.props.medecin.id\n      }, () => {}); // let videoStream = new MediaStream(stream.getVideoTracks(), options);\n\n      try {\n        this.myVideo.srcObject = stream;\n      } catch (e) {\n        this.myVideo.src = URL.createObjectURL(stream);\n      }\n\n      this.myVideo.play(); // try {\n      //     this.callerTone.src = callerTone\n      // } catch (e) {\n      //     this.callerTone.srcObject =  URL.createObjectURL(callerTone) \n      // }\n      // this.callerTone.play();\n\n      this.setState({\n        stream: stream,\n        respondingProcess: false\n      });\n    }).catch(err => {\n      this.cameraAuthDenied();\n      console.log(`Unable to fetsh stream ${err}`);\n    });\n    this.setupSocket();\n  }\n\n  componentWillUnmount() {\n    this.props.socket.removeAllListeners('patient-signal-call');\n    this.props.socket.removeAllListeners('patient-call');\n    this.props.socket.removeAllListeners('reject-call-patient');\n\n    if (this.state.peer) {\n      this.state.peer.destroy();\n    }\n  }\n\n  setupSocket() {\n    let socket = this.props.socket;\n    socket.on('patient-call', response => {});\n    socket.on('reject-call-patient', response => {\n      this.stopStream();\n      this.setState({\n        respondingProcess: false,\n        passingCall: false,\n        responding: false\n      });\n      this.props.setonCalling(false);\n    });\n    socket.on('patient-signal-call', ({\n      data\n    }) => {\n      this.setState({\n        responding: true\n      });\n      this.state.peer.signal(data);\n    });\n  }\n\n  cameraAuthDenied(reason) {\n    this.setState({\n      errorMedia: {\n        error: true,\n        reason\n      }\n    });\n  }\n\n  initiatorCallVideo(constraints) {\n    return new Promise((resolve, reject) => {\n      navigator.mediaDevices.getUserMedia(constraints).then(stream => {\n        resolve(stream);\n      }).catch(err => {\n        reject(err);\n      });\n    });\n  }\n\n  stopStream() {\n    if (this.callerTone !== null) {\n      this.callerTone.muted = true;\n      this.callerTone = null;\n    }\n\n    if (!window.streamReference) return;\n    window.streamReference.getAudioTracks().forEach(track => {\n      track.stop();\n    });\n    window.streamReference.getVideoTracks().forEach(track => {\n      track.stop();\n    });\n    window.streamReference = null;\n  }\n\n  confirmCall() {\n    const peer = new Peer({\n      initiator: true,\n      stream: this.state.stream,\n      config: {\n        iceServers: [{\n          urls: \"stun:pelia.ma:3478\"\n        }, {\n          urls: \"turn:pelia.ma:3478\",\n          username: \"peliaturn\",\n          credential: \"ejfLUNE6C=fM&4P!\"\n        }]\n      },\n      trickle: false\n    });\n    peer.on('signal', data => {\n      this.props.socket.emit('confirm-call', {\n        selectedUser: 'm' + this.props.medecin.id,\n        data\n      }, () => {});\n    });\n    peer.on('stream', stream => {\n      this.callerTone.pause();\n\n      try {\n        this.userVideo.srcObject = stream;\n      } catch (e) {\n        this.userVideo.src = URL.createObjectURL(stream);\n      }\n\n      this.userVideo.play();\n      this.setState({\n        passingCall: true,\n        respondingProcess: false,\n        timeAppel: Date.now()\n      });\n    });\n    peer.on('close', () => {\n      this.stopStream();\n      this.setState({\n        respondingProcess: false,\n        passingCall: false,\n        responding: false\n      }); // this.props.setonCalling(false)\n\n      if (this.state.peer) {\n        this.state.peer.destroy();\n      }\n    });\n    peer.on('error', err => {\n      console.log(`vous avez perdue la connextion avec votre patient ${err}`);\n    });\n    this.setState({\n      respondingProcess: true,\n      peer\n    });\n  }\n\n  rejectCall() {\n    this.stopStream();\n    this.setState({\n      respondingProcess: false,\n      passingCall: false,\n      responding: false\n    });\n    this.props.socket.emit('patient-reject-call', {\n      selectedUser: 'm' + this.props.medecin.id\n    });\n    this.props.setonCalling(false);\n  }\n\n  render() {\n    let {\n      responding,\n      passingCall,\n      respondingProcess\n    } = this.state;\n    return /*#__PURE__*/_jsxDEV(\"div\", {\n      className: \"video patient\",\n      children: [/*#__PURE__*/_jsxDEV(\"audio\", {\n        ref: ref => this.callerTone = ref,\n        playsInline: true,\n        loop: true\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 182,\n        columnNumber: 17\n      }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n        className: responding ? \"repondre video-container\" : \"video-container\",\n        children: [/*#__PURE__*/_jsxDEV(\"video\", {\n          id: \"peerVid\",\n          ref: ref => {\n            this.userVideo = ref;\n          },\n          playsInline: true,\n          autoPlay: true\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 184,\n          columnNumber: 21\n        }, this), /*#__PURE__*/_jsxDEV(Row, {\n          className: \"justify-content-center m-0\",\n          children: /*#__PURE__*/_jsxDEV(\"video\", {\n            id: \"myVid\",\n            muted: true,\n            ref: ref => {\n              this.myVideo = ref;\n            },\n            playsInline: true,\n            autoPlay: true\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 186,\n            columnNumber: 21\n          }, this)\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 185,\n          columnNumber: 17\n        }, this), /*#__PURE__*/_jsxDEV(Row, {\n          className: !passingCall ? \"responding process m-0\" : \"responding m-0\",\n          children: /*#__PURE__*/_jsxDEV(Col, {\n            className: \"p-0\",\n            children: [/*#__PURE__*/_jsxDEV(\"div\", {\n              className: \"layer\"\n            }, void 0, false, {\n              fileName: _jsxFileName,\n              lineNumber: 191,\n              columnNumber: 21\n            }, this), /*#__PURE__*/_jsxDEV(Row, {\n              className: \"mt-5\",\n              children: /*#__PURE__*/_jsxDEV(Collapse, {\n                in: this.state.errorMedia.error,\n                children: /*#__PURE__*/_jsxDEV(\"div\", {\n                  id: \"example-collapse-text\",\n                  style: {\n                    zIndex: 999\n                  },\n                  children: /*#__PURE__*/_jsxDEV(Alert, {\n                    variant: \"danger\",\n                    children: \"Vous ne autoris\\xE9 pas l'acc\\xE9s au camera pour le site ocp.pelia.ma. Changer vos param\\xE9tre pour pouvoir communiquer avec votre m\\xE9decin\"\n                  }, void 0, false, {\n                    fileName: _jsxFileName,\n                    lineNumber: 196,\n                    columnNumber: 37\n                  }, this)\n                }, void 0, false, {\n                  fileName: _jsxFileName,\n                  lineNumber: 195,\n                  columnNumber: 33\n                }, this)\n              }, void 0, false, {\n                fileName: _jsxFileName,\n                lineNumber: 194,\n                columnNumber: 29\n              }, this)\n            }, void 0, false, {\n              fileName: _jsxFileName,\n              lineNumber: 193,\n              columnNumber: 25\n            }, this), !passingCall && /*#__PURE__*/_jsxDEV(Row, {\n              className: \"text-center d-flex justify-content-around w-100 p-4 ml-1 mt-5\",\n              children: /*#__PURE__*/_jsxDEV(\"p\", {\n                className: \"text-center caller \",\n                style: {\n                  maxHeight: \"20%\"\n                },\n                children: \" Un appel entrant de la part de votre m\\xE9decin\"\n              }, void 0, false, {\n                fileName: _jsxFileName,\n                lineNumber: 205,\n                columnNumber: 37\n              }, this)\n            }, void 0, false, {\n              fileName: _jsxFileName,\n              lineNumber: 204,\n              columnNumber: 33\n            }, this), /*#__PURE__*/_jsxDEV(Row, {\n              className: \"end-call\",\n              children: [/*#__PURE__*/_jsxDEV(ButtonProcess, {\n                className: \"action\",\n                onClick: this.rejectCall,\n                type: \"button\",\n                variant: \"danger\",\n                sending: respondingProcess,\n                IconSuccess: FaCheck,\n                Icon: /*#__PURE__*/_jsxDEV(FaPhoneSlash, {\n                  size: \"1.5rem\"\n                }, void 0, false, {\n                  fileName: _jsxFileName,\n                  lineNumber: 216,\n                  columnNumber: 43\n                }, this)\n              }, void 0, false, {\n                fileName: _jsxFileName,\n                lineNumber: 209,\n                columnNumber: 29\n              }, this), !passingCall && /*#__PURE__*/_jsxDEV(ButtonProcess, {\n                className: \"action\",\n                onClick: this.confirmCall,\n                type: \"button\",\n                variant: \"success\",\n                sending: respondingProcess,\n                IconSuccess: FaCheck,\n                Icon: /*#__PURE__*/_jsxDEV(FaPhone, {\n                  size: \"1.5rem\"\n                }, void 0, false, {\n                  fileName: _jsxFileName,\n                  lineNumber: 227,\n                  columnNumber: 43\n                }, this)\n              }, void 0, false, {\n                fileName: _jsxFileName,\n                lineNumber: 220,\n                columnNumber: 33\n              }, this)]\n            }, void 0, true, {\n              fileName: _jsxFileName,\n              lineNumber: 208,\n              columnNumber: 25\n            }, this)]\n          }, void 0, true, {\n            fileName: _jsxFileName,\n            lineNumber: 190,\n            columnNumber: 21\n          }, this)\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 189,\n          columnNumber: 17\n        }, this)]\n      }, void 0, true, {\n        fileName: _jsxFileName,\n        lineNumber: 183,\n        columnNumber: 17\n      }, this)]\n    }, void 0, true, {\n      fileName: _jsxFileName,\n      lineNumber: 181,\n      columnNumber: 13\n    }, this);\n  }\n\n}\n\nfunction ButtonProcess(props) {\n  return /*#__PURE__*/_jsxDEV(\"div\", {\n    style: {\n      display: \"flex\",\n      justifyContent: \"center\",\n      position: 'relative'\n    },\n    children: [/*#__PURE__*/_jsxDEV(Button, {\n      onClick: props.onClick,\n      className: props.className,\n      type: props.type,\n      variant: props.variant,\n      disabled: props.sending,\n      children: props.Icon\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 248,\n      columnNumber: 9\n    }, this), props.sending && /*#__PURE__*/_jsxDEV(CircularProgress, {\n      size: 24,\n      style: {\n        color: \"#8dc63f\",\n        position: 'absolute',\n        top: '50%',\n        left: '50%',\n        marginTop: -12,\n        marginLeft: -12\n      }\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 257,\n      columnNumber: 27\n    }, this)]\n  }, void 0, true, {\n    fileName: _jsxFileName,\n    lineNumber: 243,\n    columnNumber: 7\n  }, this);\n}","map":{"version":3,"sources":["C:/app/doctolive_code/patient-doctolive/components/Chat/videoChat.jsx"],"names":["React","Component","Peer","autoBind","CircularProgress","Button","Row","Col","Collapse","Alert","FaPhoneSlash","FaPhone","FaCheck","ElemenetsCall","constructor","props","state","stream","respondingProcess","errorMedia","error","componentDidMount","constraints","video","facingMode","width","height","cursor","audio","initiatorCallVideo","then","window","streamReference","socket","emit","selectedUser","medecin","id","myVideo","srcObject","e","src","URL","createObjectURL","play","setState","catch","err","cameraAuthDenied","console","log","setupSocket","componentWillUnmount","removeAllListeners","peer","destroy","on","response","stopStream","passingCall","responding","setonCalling","data","signal","reason","Promise","resolve","reject","navigator","mediaDevices","getUserMedia","callerTone","muted","getAudioTracks","forEach","track","stop","getVideoTracks","confirmCall","initiator","config","iceServers","urls","username","credential","trickle","pause","userVideo","timeAppel","Date","now","rejectCall","render","ref","zIndex","maxHeight","ButtonProcess","display","justifyContent","position","onClick","className","type","variant","sending","Icon","color","top","left","marginTop","marginLeft"],"mappings":"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","sourcesContent":["\r\n\r\nimport React, { Component } from 'react';\r\nimport Peer from 'simple-peer';\r\nimport autoBind from 'react-autobind';\r\n// import Axios from 'axios'\r\n\r\n// import baseUrl from './../../config'\r\n\r\nimport {CircularProgress} from '@material-ui/core';\r\nimport { Button, Row, Col, Collapse, Alert} from 'react-bootstrap'\r\nimport {FaPhoneSlash, FaPhone, FaCheck} from 'react-icons/fa'\r\n// import callerTone from './../../assets/media/callertone.mp3'\r\n\r\n// import LogoPng from './../../assets/img/pelia_logo.png'\r\n\r\n\r\nexport default class ElemenetsCall extends Component {\r\n    constructor(props) {\r\n        super(props);\r\n        autoBind(this);\r\n        this.state = {\r\n            stream: null,\r\n            respondingProcess:true,\r\n            errorMedia:{error:false}\r\n        };\r\n    }\r\n    componentDidMount() {\r\n        const constraints={\r\n            video: {\r\n                facingMode: \"user\", \r\n                width: 640, \r\n                height: 480, \r\n                cursor:\"motion\"\r\n            }, \r\n            audio:true\r\n         }\r\n\r\n        this.initiatorCallVideo(constraints)\r\n        .then((stream) => {\r\n            window.streamReference = stream;           \r\n            this.props.socket.emit('patient-ready', {selectedUser: 'm' + this.props.medecin.id}, () => { } )\r\n            // let videoStream = new MediaStream(stream.getVideoTracks(), options);\r\n            try {\r\n                this.myVideo.srcObject = stream;\r\n            } catch (e) {\r\n                this.myVideo.src = URL.createObjectURL(stream)\r\n            }\r\n            this.myVideo.play();\r\n            // try {\r\n            //     this.callerTone.src = callerTone\r\n            // } catch (e) {\r\n            //     this.callerTone.srcObject =  URL.createObjectURL(callerTone) \r\n            // }\r\n            // this.callerTone.play();\r\n            this.setState({ stream : stream, respondingProcess: false})\r\n        })\r\n        .catch((err)=> {\r\n            this.cameraAuthDenied()\r\n            console.log(`Unable to fetsh stream ${err}`)\r\n        })\r\n        this.setupSocket()\r\n    }\r\n    componentWillUnmount(){\r\n        this.props.socket.removeAllListeners('patient-signal-call')\r\n        this.props.socket.removeAllListeners('patient-call')\r\n        this.props.socket.removeAllListeners('reject-call-patient')\r\n\r\n        if(this.state.peer){\r\n            this.state.peer.destroy();\r\n        }\r\n    }\r\n    setupSocket(){\r\n        let socket = this.props.socket;\r\n        socket.on('patient-call', (response) => {\r\n   \r\n        })\r\n        socket.on('reject-call-patient', (response) => {\r\n            this.stopStream();\r\n            this.setState({ respondingProcess:false, passingCall: false,responding:false});\r\n            this.props.setonCalling(false)\r\n        })\r\n        socket.on('patient-signal-call', ({data}) => {\r\n            this.setState({responding: true})\r\n            this.state.peer.signal(data);\r\n        })\r\n    }\r\n\r\n    cameraAuthDenied(reason){\r\n        this.setState({errorMedia: {error: true, reason}})\r\n    }\r\n    \r\n     initiatorCallVideo(constraints){\r\n      \r\n        return new Promise((resolve, reject) => {\r\n            navigator.mediaDevices.getUserMedia(constraints)\r\n            .then((stream) => {\r\n                resolve(stream)\r\n            })\r\n            .catch(err => {\r\n                reject(err)\r\n            })\r\n        });\r\n    }\r\n    \r\n    stopStream() {\r\n        if(this.callerTone !== null){\r\n            this.callerTone.muted = true;\r\n            this.callerTone= null;\r\n        }\r\n        if (!window.streamReference) return;\r\n        window.streamReference.getAudioTracks().forEach( (track) => {\r\n            track.stop();\r\n        });\r\n        window.streamReference.getVideoTracks().forEach( (track) => {\r\n            track.stop();\r\n        });\r\n        window.streamReference = null;\r\n    }\r\n\r\n\r\n    confirmCall(){\r\n    const peer = new Peer({\r\n        initiator:true,\r\n        stream: this.state.stream,\r\n        config: { iceServers: \r\n            [\r\n                {\r\n                    urls: \"stun:pelia.ma:3478\",\r\n                },\r\n                {\r\n                    urls: \"turn:pelia.ma:3478\",\r\n                    username: \"peliaturn\",\r\n                    credential: \"ejfLUNE6C=fM&4P!\"\r\n                }\r\n            ]\r\n        },\r\n        trickle: false\r\n    });\r\n    peer.on('signal', (data) => {\r\n        this.props.socket.emit('confirm-call', {selectedUser: 'm' + this.props.medecin.id, data }, () => { })\r\n    })\r\n\r\n    peer.on('stream', (stream) => {\r\n        this.callerTone.pause();\r\n        try {\r\n            this.userVideo.srcObject = stream;\r\n        } catch (e) {\r\n            this.userVideo.src = URL.createObjectURL(stream)\r\n        }\r\n        this.userVideo.play();\r\n        this.setState({passingCall: true, respondingProcess:false, timeAppel: Date.now() })\r\n    })\r\n    peer.on('close', () =>{\r\n        this.stopStream();\r\n        this.setState({ respondingProcess:false, passingCall: false,responding:false });\r\n        // this.props.setonCalling(false)\r\n        if(this.state.peer){\r\n            this.state.peer.destroy()\r\n        }\r\n    });\r\n\r\n    peer.on('error', (err) => {\r\n        console.log( `vous avez perdue la connextion avec votre patient ${err}`)\r\n    });\r\n    this.setState({ respondingProcess: true, peer});\r\n    \r\n    }\r\n\r\n    rejectCall(){\r\n\r\n            this.stopStream();\r\n            this.setState({ respondingProcess:false, passingCall: false, responding:false});\r\n            this.props.socket.emit('patient-reject-call', {selectedUser: 'm' + this.props.medecin.id})\r\n            this.props.setonCalling(false)\r\n    }\r\n      \r\n    render() {\r\n        let {responding, passingCall, respondingProcess } = this.state;\r\n        return (\r\n            <div className=\"video patient\">\r\n                <audio ref={ref => this.callerTone = ref} playsInline loop />\r\n                <div className={responding ? \"repondre video-container\" : \"video-container\"}>\r\n                    <video id=\"peerVid\" ref={(ref) => {this.userVideo = ref;}} playsInline autoPlay />\r\n                <Row className=\"justify-content-center m-0\">\r\n                    <video id=\"myVid\" muted={true} ref={(ref) => {this.myVideo = ref;}} playsInline autoPlay />\r\n                </Row>    \r\n\r\n                <Row className={!passingCall ? \"responding process m-0\": \"responding m-0\"}>   \r\n                    <Col className=\"p-0\">\r\n                    <div className=\"layer\"></div>\r\n                        \r\n                        <Row className=\"mt-5\">\r\n                            <Collapse in={this.state.errorMedia.error}>\r\n                                <div id=\"example-collapse-text\" style={{zIndex:999}}>\r\n                                    <Alert  variant=\"danger\">\r\n                                        Vous ne autorisé pas l'accés au camera pour le site ocp.pelia.ma. Changer vos paramétre pour pouvoir communiquer avec votre médecin\r\n                                    </Alert>\r\n                                </div>\r\n                            </Collapse>\r\n                        </Row>\r\n                        \r\n                            { !passingCall &&                      \r\n                                <Row className=\"text-center d-flex justify-content-around w-100 p-4 ml-1 mt-5\">   \r\n                                    <p className=\"text-center caller \" style={{maxHeight: \"20%\"}}> Un appel entrant de la part de votre médecin</p>\r\n                                </Row>    \r\n                            }\r\n                        <Row className=\"end-call\">\r\n                            <ButtonProcess \r\n                                    className=\"action\" \r\n                                    onClick={this.rejectCall} \r\n                                    type=\"button\"   \r\n                                    variant=\"danger\" \r\n                                    sending={respondingProcess} \r\n                                    IconSuccess={FaCheck} \r\n                                    Icon={<FaPhoneSlash size=\"1.5rem\" />}\r\n                                />\r\n                                    \r\n                            { !passingCall &&\r\n                                <ButtonProcess \r\n                                    className=\"action\" \r\n                                    onClick={this.confirmCall} \r\n                                    type=\"button\" \r\n                                    variant=\"success\" \r\n                                    sending={respondingProcess} \r\n                                    IconSuccess={FaCheck} \r\n                                    Icon={<FaPhone size=\"1.5rem\" />}\r\n                                />\r\n                            }\r\n                        </Row>\r\n                    </Col>\r\n                </Row>\r\n                \r\n               \r\n                </div>\r\n            </div>\r\n        );\r\n    }\r\n}\r\n\r\nfunction ButtonProcess(props) {\r\n  return (\r\n      <div style={{\r\n        display:\"flex\",\r\n        justifyContent:\"center\",\r\n        position: 'relative',\r\n      }}>\r\n        <Button\r\n        onClick={props.onClick }\r\n        className={props.className}\r\n          type={props.type}\r\n          variant= {props.variant}\r\n          disabled={props.sending}\r\n        >\r\n           {props.Icon}\r\n        </Button>\r\n        {props.sending && <CircularProgress size={24} style={ {color: \"#8dc63f\", position: 'absolute',top: '50%', left: '50%',marginTop: -12,marginLeft: -12}}  /> }\r\n      </div>\r\n  );\r\n}\r\n\r\n\r\n"]},"metadata":{},"sourceType":"module"}